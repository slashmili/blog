[{"content":"While implementing a feature to store event dates, I stumbled upon what I initially thought was a straightforward task: saving future dates in a database along with their time zones. How hard could it be, right? Turns out, it‚Äôs not so simple.\nThe first Attemp: TIMESTAMP WITH TIME ZONE #My first approach was to use PostgreSQL‚Äôs TIMESTAMP WITH TIME ZONE column type.\nschema \u0026#34;events_v1\u0026#34; do field(:name, :string) field(:start_datetime, :utc_datetime) end After all, it has ‚ÄúWITH TIME ZONE‚Äù right in the name! But I quickly discovered two key issues:\nAutomatic UTC Conversion: When you store a timestamp with time zone, PostgreSQL converts it to UTC for storage. Loss of Time Zone Information: The original time zone you provided isn‚Äôt stored, only the UTC equivalent. This meant I couldn‚Äôt accurately represent the original time zone of the event.\nYou can try it yourself using livebook\nThe Second Attempt: Storing the Time Zone Separately #Next, I decided to store the time zone in a separate column alongside the timestamp.\nschema \u0026#34;events_v2\u0026#34; do field(:name, :string) field(:start_datetime, :utc_datetime) field(:start_datetime_time_zone, :string) end While this approach allowed me to retain the time zone information, it introduced additional complexity:\nExtra overhead in managing and ensuring the correctness of the time zone data. A more complicated query structure when working with these columns. I need to reload the start_datetime with the provided time zone on each query. view the code snippet\nAt first, I was content with this approach‚Äîat least for the initial version of my app‚Äîuntil I came across a BlueSky post that challenged my assumptions.\nüîó Storing times for human events #best-practice #database #postgresql #reading-list #sql\n\u0026mdash; Pieter Claerhout (@yellowduck.be) 2024-12-25T09:00:02.854865Z The Challenge of Time Zones #What I hadn‚Äôt considered was the ever-changing nature of time zones. They‚Äôre not immutable facts but are subject to political and cultural decisions. Countries often change daylight saving rules, and in some extreme cases, Lebanon had two time zones for a some period depends on whom you were dealing with.[2].\nThe Final Approach: The ‚ÄúWall Clock‚Äù Timestamp #To address these challenges, I adopted a hybrid solution:\nschema \u0026#34;events_v3\u0026#34; do field(:name, :string) field(:start_datetime, :naive_datetime) field(:start_datetime_time_zone, :string) field(:start_datetime_utc, :utc_datetime) end def changeset(product, params \\\\ %{}) do product |\u0026gt; cast(params, [:name, :start_datetime, :start_datetime_time_zone]) |\u0026gt; validate_required([:name, :start_datetime, :start_datetime_time_zone]) |\u0026gt; maybe_cast_utc_datetime() end Store the literal timestamp: This represents the exact time the user provides, often called a ‚Äúwall clock‚Äù timestamp (naive_datetime in Ecto). Retain the time zone in a separate column: This allows me to reconstruct the full context of the event‚Äôs time while acknowledging that time zones may change in the future. Calculate UTC timezone for query and other db operation. view the code snippet\nBy combining these, I ensure that my application captures both the event‚Äôs ‚Äúreal-world‚Äù timestamp(as the user sees it on the wall) and its contextual time zone information. It also remove the need of manually applying timezone on the datetime field after data is loaded from the database.\nResources # https://simonwillison.net/2024/Nov/27/storing-times-for-human-events/ https://hexdocs.pm/tz_datetime/TzDatetime.html ","date":"18 January 2025","permalink":"/posts/ecto-datetime-with-time-zone/","section":"Posts","summary":"","title":"Ecto Datetime With Time Zone"},{"content":"","date":null,"permalink":"/","section":"Milad's Notes","summary":"","title":"Milad's Notes"},{"content":"","date":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts"},{"content":"","date":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"","date":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags"}]